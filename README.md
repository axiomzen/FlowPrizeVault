# PrizeSavings

**A No-Loss Lottery Protocol on Flow**

PrizeSavings is a prize-linked savings protocol where users deposit tokens to earn guaranteed savings interest while also having chances to win lottery prizes. Users never lose their principalâ€”all prizes come from yield generated by deposits.

> âš ï¸ **Audit Status**: This contract is currently undergoing security audit.

## Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Core Contracts](#core-contracts)
- [Key Mechanisms](#key-mechanisms)
- [Getting Started](#getting-started)
- [User Flows](#user-flows)
- [Pool Configuration](#pool-configuration)
- [Scripts & Queries](#scripts--queries)
- [Events](#events)
- [Security Considerations](#security-considerations)
- [External Dependencies](#external-dependencies)
- [Testing](#testing)
- [Deployment](#deployment)

---

## Overview

PrizeSavings implements a "no-loss lottery" where:

1. **Users deposit tokens** into savings pools
2. **Deposits are sent to yield sources** (modular DeFi integrations)
3. **Yield is split** between savings interest, lottery prizes, and treasury (configurable)
4. **Periodic lottery draws** award prizes to depositors (weighted by balance Ã— time)
5. **Users can withdraw** their principal + accrued savings interest at any time

### Key Properties

- **No Loss**: Users always retain access to their principal + savings interest
- **Fair Odds**: Lottery odds are weighted by time-weighted average balance (TWAB)
- **Provably Fair**: Uses Flow's on-chain randomness (commit-reveal scheme)
- **Gas Efficient**: ERC4626-style shares enable O(1) interest distribution
- **Modular**: Pluggable yield sources, distribution strategies, and winner selection

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              PrizeSavings                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ PoolPositionCollectionâ”‚    â”‚       Admin        â”‚                     â”‚
â”‚  â”‚  (per user)          â”‚    â”‚  (protocol owner)  â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚             â”‚                          â”‚                                â”‚
â”‚             â–¼                          â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                            Pool                                   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚SavingsDistributorâ”‚  â”‚LotteryDistributorâ”‚  â”‚TreasuryDistributorâ”‚ â”‚  â”‚
â”‚  â”‚  â”‚ (shares/TWAB)   â”‚  â”‚ (prizes/NFTs)   â”‚  â”‚  (protocol fees) â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚           â”‚                    â”‚                      â”‚           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                    â”‚                      â”‚              â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                   â–¼                                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚    Yield Connector (DeFi)   â”‚                      â”‚
â”‚                    â”‚   (modular yield source)    â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Core Contracts

### `PrizeSavings.cdc`

The main protocol contract containing:

| Component | Description |
|-----------|-------------|
| **Pool** | Core resource managing deposits, withdrawals, yield processing, and prize draws |
| **SavingsDistributor** | ERC4626-style shares vault with epoch-based TWAB tracking |
| **LotteryDistributor** | Prize pool management, NFT prizes, and draw execution |
| **TreasuryDistributor** | Protocol fee collection and withdrawals |
| **PoolPositionCollection** | User-owned resource for interacting with pools |
| **Admin** | Privileged operations (strategy updates, emergency controls) |

### `PrizeWinnerTracker.cdc`

Optional pluggable winner history tracking using a ring buffer pattern. Can be attached to pools for leaderboard/history features.

---

## Key Mechanisms

### Shares Model (ERC4626-Style)

Interest distribution uses a shares-based model for O(1) gas efficiency:

```
shares = (depositAmount Ã— totalShares) / totalAssets
userValue = (userShares Ã— totalAssets) / totalShares
```

When yield is distributed, `totalAssets` increases while shares remain constantâ€”automatically increasing each user's proportional value.

> ðŸ“– **[Read the full Accounting & Shares documentation â†’](./docs/ACCOUNTING.md)**

### Time-Weighted Average Balance (TWAB)

Lottery odds are based on **share-seconds**â€”shares held multiplied by time held during the epoch:

```
timeWeightedStake = userShares Ã— (currentTime - lastUpdateTime)
lotteryWeight = cumulativeShareSeconds + currentElapsed
```

This ensures:
- Larger deposits = better odds
- Longer deposits = better odds
- Late depositors don't get retroactive weight

> ðŸ“– **[Read the full TWAB documentation â†’](./docs/TWAB.md)**

### Randomness (Commit-Reveal)

Lottery draws use Flow's `RandomConsumer` for provably fair selection:

1. **`startDraw()`**: Commits to a future block's randomness, snapshots TWAB weights
2. **Wait 1 block**: Randomness source block is mined
3. **`completeDraw()`**: Reveals random number, selects winner(s), distributes prizes

### Distribution Strategies

Configurable splits between savings/lottery/treasury:

| Strategy | Description |
|----------|-------------|
| `FixedPercentageStrategy` | Static split (e.g., 50% savings, 40% lottery, 10% treasury) |

Custom strategies can implement the `DistributionStrategy` interface.

### Winner Selection Strategies

| Strategy | Description |
|----------|-------------|
| `WeightedSingleWinner` | One winner takes all, weighted by TWAB |
| `MultiWinnerSplit` | Multiple winners with configurable prize splits |
| `FixedPrizeTiers` | Fixed prize amounts per tier (e.g., 1st: 100, 2nd: 50, 3rd: 25) |

### Emergency Mode

Automatic health monitoring with configurable thresholds:

| State | Description |
|-------|-------------|
| `Normal` | All operations enabled |
| `Paused` | All operations disabled |
| `EmergencyMode` | Withdrawals only (no deposits/draws) |
| `PartialMode` | Limited deposits, withdrawals enabled |

Auto-triggers based on yield source health, withdrawal failures, or balance thresholds.

---

## Getting Started

### Prerequisites

- [Flow CLI](https://docs.onflow.org/flow-cli/install/) installed
- Flow emulator or testnet access

### 1. Deploy Contracts

```bash
# Start emulator
flow emulator

# Deploy to emulator
flow project deploy --network=emulator
```

### 2. Setup User Collection

Users must create a `PoolPositionCollection` before interacting:

```bash
flow transactions send cadence/transactions/prize-vault-modular/setup_collection.cdc \
  --network=emulator --signer=user-account
```

### 3. Deposit into Pool

```bash
flow transactions send cadence/transactions/prize-vault-modular/deposit.cdc \
  --args UInt64:0 UFix64:100.0 \
  --network=emulator --signer=user-account
```

### 4. Query Balance

```bash
flow scripts execute cadence/scripts/prize-vault-modular/get_pool_balance.cdc \
  --args UInt64:0 Address:0xUSER_ADDRESS \
  --network=emulator
```

---

## User Flows

### Depositing

```cadence
// Borrow user's collection
let collection = signer.storage.borrow<&PrizeSavings.PoolPositionCollection>(
    from: PrizeSavings.PoolPositionCollectionStoragePath
)!

// Withdraw tokens from wallet
let tokens <- flowVault.withdraw(amount: 100.0)

// Deposit into pool (auto-registers on first deposit)
collection.deposit(poolID: 0, from: <-tokens)
```

### Withdrawing

```cadence
// Withdraw principal + accrued savings interest
let withdrawn <- collection.withdraw(poolID: 0, amount: 50.0)
```

### Checking Balance

```cadence
let balance = collection.getPoolBalance(poolID: 0)
// balance.deposits: original principal
// balance.savingsEarned: accrued interest
// balance.totalBalance: deposits + savingsEarned
```

---

## Pool Configuration

Pools are created with a `PoolConfig`:

```cadence
let config = PrizeSavings.PoolConfig(
    assetType: Type<@FlowToken.Vault>(),
    yieldConnector: connector,          // DeFiActions.Connector
    minimumDeposit: 1.0,                 // Minimum deposit amount
    drawIntervalSeconds: 86400.0,        // 24 hours between draws
    distributionStrategy: strategy,      // FixedPercentageStrategy
    winnerSelectionStrategy: winnerStrategy,
    winnerTrackerCap: nil                // Optional tracker
)
```

### Emergency Configuration

```cadence
let emergencyConfig = PrizeSavings.EmergencyConfig(
    maxEmergencyDuration: 86400.0,       // Auto-recover after 24h
    autoRecoveryEnabled: true,
    minYieldSourceHealth: 0.5,           // Trigger at 50% health
    maxWithdrawFailures: 3,              // Trigger after 3 failures
    partialModeDepositLimit: 100.0,
    minBalanceThreshold: 0.95,           // 95% balance required
    minRecoveryHealth: 0.5
)
```

---

## Scripts & Queries

| Script | Description |
|--------|-------------|
| `get_pool_stats.cdc` | Pool totals, config, draw status |
| `get_pool_balance.cdc` | User balance in a pool |
| `get_all_pools.cdc` | List all pool IDs |
| `get_winner_history.cdc` | Recent winners (if tracker enabled) |

---

## Events

### Deposits & Withdrawals
- `Deposited(poolID, receiverID, amount)`
- `Withdrawn(poolID, receiverID, amount)`

### Rewards & Distribution
- `RewardsProcessed(poolID, totalAmount, savingsAmount, lotteryAmount)`
- `SavingsYieldAccrued(poolID, amount)`
- `LotteryPrizePoolFunded(poolID, amount, source)`

### Lottery
- `PrizeDrawCommitted(poolID, prizeAmount, commitBlock)`
- `PrizesAwarded(poolID, winners, amounts, round)`

### NFT Prizes
- `NFTPrizeDeposited(poolID, nftID, nftType, depositedBy)`
- `NFTPrizeAwarded(poolID, receiverID, nftID, nftType, round)`
- `NFTPrizeClaimed(poolID, receiverID, nftID, nftType)`

### Emergency
- `PoolEmergencyEnabled(poolID, reason, enabledBy, timestamp)`
- `PoolEmergencyDisabled(poolID, disabledBy, timestamp)`
- `EmergencyModeAutoTriggered(poolID, reason, healthScore, timestamp)`
- `EmergencyModeAutoRecovered(poolID, reason, healthScore, duration, timestamp)`

### Admin Actions
- `DistributionStrategyUpdated(poolID, oldStrategy, newStrategy, updatedBy)`
- `WinnerSelectionStrategyUpdated(poolID, oldStrategy, newStrategy, updatedBy)`
- `DrawIntervalUpdated(poolID, oldInterval, newInterval, updatedBy)`

---

## Security Considerations

### Trust Assumptions

| Component | Trust Level | Notes |
|-----------|-------------|-------|
| Admin | High | Can update strategies, enable emergency mode, withdraw treasury |
| Yield Source | High | Protocol depends on yield source solvency |
| RandomConsumer | Core Flow | Flow protocol-level randomness |

### Key Invariants

1. `sum(userShareValues) == totalAssets`
2. Users can always withdraw `principal + savingsInterest` (when not paused)
3. Lottery prizes never exceed accumulated lottery yield
4. `totalShares` and `totalAssets` never underflow

### Rounding & Dust

- Share conversions may produce small rounding dust
- Dust is tracked and periodically sent to treasury
- Minimum deposit prevents dust-only positions

### Access Control

| Function | Access |
|----------|--------|
| `deposit()` / `withdraw()` | Any user (own collection) |
| `startDraw()` / `completeDraw()` | Anyone (if conditions met) |
| `processRewards()` | Anyone (permissionless) |
| `Admin.*` | Admin resource holder only |
| `Pool.registerReceiver()` | Contract-internal only |

---

## External Dependencies

| Contract | Address (Mainnet) | Purpose |
|----------|-------------------|---------|
| `FungibleToken` | `f233dcee88fe0abe` | Token standard |
| `NonFungibleToken` | `1d7e57aa55817448` | NFT prize support |
| `RandomConsumer` | `45caec600164c9e6` | On-chain randomness |
| `DeFiActions` | `92195d814edf9cb0` | Yield source connectors (BETA) |
| `FlowTransactionScheduler` | `e467b9dd11fa00df` | Automated draws |

---

## Testing

### Run Tests

```bash
flow test cadence/tests/PrizeSavings_shares_test.cdc
flow test cadence/tests/PrizeVault_test.cdc
```

### Test Coverage

| Area | Tests |
|------|-------|
| Shares math (ERC4626) | Deposit, withdrawal, interest distribution, late joiner fairness |
| Invariants | Total assets, underflow protection |

---

## Deployment

### Networks

| Network | Contract Address | Status |
|---------|------------------|--------|
| Emulator | `f8d6e0586b0a20c7` | Development |
| Testnet | `8f7109e18153bfb3` | Testing |
| Mainnet | TBD | Pending Audit |

### Deployment Order

1. `PrizeWinnerTracker` (optional)
2. `PrizeSavings`
3. `PrizeVaultScheduler` (optional, for automated draws)

---

## License

MIT

---

## Contact

For questions or support, please open an issue on this repository.

